<%- include('layout.ejs'); %>
<div id="layoutSidenav">
  <%- include('nav.ejs'); %>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"
    integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous">
  </script>



  <div id="layoutSidenav_content">
    <main>
      <div class="col-lg-8 col-12 px-4 mx-auto bg-white p-4 mb-4  rounded border border-light">
        <div class="row">
          <div class="col-6"> <img src="../1664953679892.png" width="90" /></div>
          <div class="col-6">
            <h1 class="txt-h">Quotation</h1>
          </div>
        </div>

        <div>

          <div class="col-lg-12 col-12">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col-6 txt mb-5">Quotation No : <%= date %></div>
                  <div class="col-6 txt mb-5">Quotation Date : <%= date %></div>
                </div>

                Quotation For
                <select class="form-control txt-d mb-3">
                  <option>Select a Client</option>
                </select>

                <div class="card bg-white text-center">
                  <div class="card-body txt">
                    <i class="fas fa-user-circle fa-4x" aria-hidden="true"></i>
                    <div class="txt-d">

                      Select a Client/Business from list
                    </div>
                    <div class="txt-d">
                      Or
                    </div>
                    <button class="btn btn-primary btn-sm txt-button" id="new_client">Add New Client</button>
                  </div>

                </div>
              </div>
            </div>



            <form name="add_name" id="add_name" method="post">
              <div class="card-header bg text-white txt-d">Item</div>
              <div>
                <div id="dynamic_field">
                  <div class="card mt-3 bg-section " id="row1">
                    <div class="card-body">
                      <div class="dynamic-added">
                        <div class="row">
                          <div class="col-lg-6 number">1.
                          </div>
                          <div class="col-lg-6 text-end number"><i class="fa fa-times btn_remove" id="1"
                              aria-hidden="true"></i></div>
                        </div>
                        <div class="row mb-3">
                          <div class="col-lg-6 col-sm-6 col-12 txt-d">Item</div>
                          <div class="col-lg-6 col-sm-6 col-12">






                            <!-- 
                            <div class="dropdown">
                              <input class="btn btn-secondary dropdown-toggle" id="dropdownMenuButton"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">

                                <% users.forEach((user) => { %>
                                <a class="dropdown-item" href="#"><input type="radio"
                                    name="item"><%= user.item_name %></a>

                                <% }); %>


                             
                              </div>
                            </div> -->



                            <select class="form-control txt-d-form item" id="item_select1" name="1">
                              <% users.forEach((user) => { %>
                              <option><%= user.item_name %></option>
                              <% }); %>
                            </select>
                          </div>
                        </div>
                      </div>
                      <div class="row mb-3 txt-d-form">
                        <div class="col-lg-6 col-sm-6 col-12">Type</div>
                        <div class="col-lg-6 col-sm-6 col-12"><select class="form-control txt-d-form type_name" name="1"
                            id="type1">
                            <option>Furniture</option>
                            <option>Build in</option>
                          </select></div>
                        <div class="col-lg-6 col-sm-6 col-12 txt-d-form">Dimemsion</div>
                        <div class="col-lg-6 col-sm-6 col-12">
                          <div id="dimemsion_section1"><input type="text" class="form-control"></div>
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-lg-6 col-sm-6 col-12 txt-d-form">Add On</div>
                        <div class="col-lg-6 col-sm-6 col-12">
                          <div id="addon_section1"></div><input type="text" class="form-control txt-d-form">
                        </div>
                        <div class="col-lg-6 col-sm-6 col-12 txt-d-form">Material</div>
                        <div class="col-lg-6 col-sm-6 col-12">
                          <select class="form-control txt-d-form material" name="1" id="material1"></select></div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-lg-6 col-sm-6 col-12 txt-d-form">Amount</div>
                        <div class="col-lg-6 col-sm-6 col-12">
                          <input type="text" class="form-control txt-d-form amount" id="amount1"></div>
                      </div>
                      <div></div>
                    </div>
                  </div>
                </div>
              </div>
          </div>
          <div class="row mb-3">
            <div class="col-lg-6 col-12">
            </div>
            <div class="col-lg-6 col-12">
              <div class="total_txt">
                Total ( THB )
              </div>
              <div>
                <div>
                  <h1 id="total_amount">THB 0</h1>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6 col-6">
            </div>
            <div class="col-lg-6 col-12">

              <div class="signature_txt">Signature</div>

              <div class="row">
                <div class="col-md-12">
                  <img id="sig-image" src="" alt="Your signature will go here!" style="display: none;" />
                </div>
              </div>


              <div><button class="btn btn-primary txt-button" id="signature" type="button">Signature Here</button></div>

              <div class="row">
                <div class="col-md-12">
                  <!-- <textarea id="sig-dataUrl" class="form-control" rows="5">Data URL for your signature will go here!</textarea>  -->
                </div>
              </div>
              <br />

            </div>
          </div>
          <!-- Content -->
          <div class="row">
            <div class="col-4 pl-0 pr-0">

              <button class="btn btn-secondary btn-block txt-button" ame="add" id="add" type="button"><i
                  class="fa fa-plus-square" aria-hidden="true"></i> Add New
                Line</button>


            </div>
            <div class="col-4 pl-0 pr-0">

              <button class="btn btn-secondary btn-block  txt-button" type="button" id="add_group"><i
                  class="fa fa-plus-square" aria-hidden="true"></i> Add New Group</button>
            </div>

            <div class="col-lg-4 col-4 pl-0 pr-0">

              <button class="btn btn-secondary btn-block  txt-button" type="button" id="add_main"><i
                  class="fa fa-plus-square" aria-hidden="true"></i> Add New Main</button>

            </div>
          </div>

          <div class="row mt-4 mb-4">
            <div class="col-6 text-end">
              <input type="submit" name="submit" id="submit" class="btn btn-draft btn-sm" value="Save As Draft" />
            </div>
            <div class="col-6">

              <input type="submit" name="submit" id="submit" class="btn btn-info btn-sm btn-save"
                value="Save & Continue" />
            </div>
          </div>
          </form>
        </div>
        <div class="modal" tabindex="-1" id="new_client_modal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="txt-h-modal">Add New Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="txt-modal">
                  Basic Information
                </div>
                <div class="mb-3">
                  <label class="txt-modal">Business Name</label>
                  <input type="email" class="form-control txt-modal-txtbox" placeholder="Business Name">
                </div>
                <div class="mb-3">
                  <label class="txt-modal">Email</label>
                  <input type="email" class="form-control txt-modal-txtbox" placeholder="Email">
                </div>
                <div class="txt-modal">
                  Phone Number
                  <input type="text" class="form-control txt-modal-txtbox" placeholder="phone number">
                </div>
                <div class="mb-3">
                  <label class="txt-modal">Address</label>
                  <textarea type="email" class="form-control txt-modal-txtbox" placeholder="address"></textarea>
                </div>
                <button type="button" class="btn btn-danger btn-sm txt-button">Save</button>
              </div>
            </div>
          </div>
        </div>





        <div class="modal" tabindex="-1" role="dialog" id="signature_modal">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Signature</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div>
                  <canvas id="sig-canvas">
                    Get a better browser, bro.
                  </canvas>
                </div>
                <button class="btn btn-primary" id="sig-submitBtn" type="button"><i class="fa fa-check"
                    aria-hidden="true"></i></button>
                <button class="btn btn-danger" id="sig-clearBtn" type="button"><i class="fa fa-refresh"
                    aria-hidden="true"></i></button>
                <br />

              </div>

            </div>
          </div>
        </div>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

        <script type="text/javascript">
          $(document).ready(function () {





            (function () {
              window.requestAnimFrame = (function (callback) {
                return window.requestAnimationFrame ||
                  window.webkitRequestAnimationFrame ||
                  window.mozRequestAnimationFrame ||
                  window.oRequestAnimationFrame ||
                  window.msRequestAnimaitonFrame ||
                  function (callback) {
                    window.setTimeout(callback, 1000 / 60);
                  };
              })();

              var canvas = document.getElementById("sig-canvas");
              var ctx = canvas.getContext("2d");
              ctx.strokeStyle = "#222222";
              ctx.lineWidth = 4;

              var drawing = false;
              var mousePos = {
                x: 0,
                y: 0
              };
              var lastPos = mousePos;

              canvas.addEventListener("mousedown", function (e) {
                drawing = true;
                lastPos = getMousePos(canvas, e);
              }, false);

              canvas.addEventListener("mouseup", function (e) {
                drawing = false;
              }, false);

              canvas.addEventListener("mousemove", function (e) {
                mousePos = getMousePos(canvas, e);
              }, false);

              // Add touch event support for mobile
              canvas.addEventListener("touchstart", function (e) {

              }, false);

              canvas.addEventListener("touchmove", function (e) {
                var touch = e.touches[0];
                var me = new MouseEvent("mousemove", {
                  clientX: touch.clientX,
                  clientY: touch.clientY
                });
                canvas.dispatchEvent(me);
              }, false);

              canvas.addEventListener("touchstart", function (e) {
                mousePos = getTouchPos(canvas, e);
                var touch = e.touches[0];
                var me = new MouseEvent("mousedown", {
                  clientX: touch.clientX,
                  clientY: touch.clientY
                });
                canvas.dispatchEvent(me);
              }, false);

              canvas.addEventListener("touchend", function (e) {
                var me = new MouseEvent("mouseup", {});
                canvas.dispatchEvent(me);
              }, false);

              function getMousePos(canvasDom, mouseEvent) {
                var rect = canvasDom.getBoundingClientRect();
                return {
                  x: mouseEvent.clientX - rect.left,
                  y: mouseEvent.clientY - rect.top
                }
              }

              function getTouchPos(canvasDom, touchEvent) {
                var rect = canvasDom.getBoundingClientRect();
                return {
                  x: touchEvent.touches[0].clientX - rect.left,
                  y: touchEvent.touches[0].clientY - rect.top
                }
              }

              function renderCanvas() {
                if (drawing) {
                  ctx.moveTo(lastPos.x, lastPos.y);
                  ctx.lineTo(mousePos.x, mousePos.y);
                  ctx.stroke();
                  lastPos = mousePos;
                }
              }

              // Prevent scrolling when touching the canvas
              document.body.addEventListener("touchstart", function (e) {
                if (e.target == canvas) {
                  e.preventDefault();
                }
              }, false);
              document.body.addEventListener("touchend", function (e) {
                if (e.target == canvas) {
                  e.preventDefault();
                }
              }, false);
              document.body.addEventListener("touchmove", function (e) {
                if (e.target == canvas) {
                  e.preventDefault();
                }
              }, false);

              (function drawLoop() {
                requestAnimFrame(drawLoop);
                renderCanvas();
              })();

              function clearCanvas() {
                canvas.width = canvas.width;
              }

              // Set up the UI
              var sigText = document.getElementById("sig-dataUrl");
              var sigImage = document.getElementById("sig-image");
              var clearBtn = document.getElementById("sig-clearBtn");
              var submitBtn = document.getElementById("sig-submitBtn");
              clearBtn.addEventListener("click", function (e) {
                clearCanvas();
                sigText.innerHTML = "Data URL for your signature will go here!";
                sigImage.setAttribute("src", "");
              }, false);
              submitBtn.addEventListener("click", function (e) {
                var dataUrl = canvas.toDataURL();

                $('#signature_modal').modal('hide');
                // sigText.innerHTML = dataUrl;

                $('#sig-image').css('display', 'block');

                sigImage.setAttribute("src", dataUrl);
              }, false);

            })();
            $('#signature').click(function () {
              $('#signature_modal').modal('show');
            });

            function sum() {
              var sum_amount = 0;
              $('.amount').each(function () {
                sum_amount += +$(this).val();
                $('#total_amount').html('THB ' + sum_amount);
              })

            }

            function calculate(id) {
              var item_id = $('#item_select' + id + '').val();
              var type_id = $('#type' + id + '').val();
              var widht_id = $('#width' + id + '').val();
              var material_id = $('#material' + id + '').val();
              if ((type_id == 1) && (item_id !== null) && (widht_id !== null) && (material_id !== null)) {
                // alert('1');
                $.ajax({
                  url: 'http://localhost:9144/calculate_furniture',
                  method: "post",
                  type: 'json',
                  data: {
                    item_id: item_id,
                    type_id: type_id,
                  },
                  success: function (data) {

                    console.log(data[0].price);

                    var amount = (widht_id * data[0].price) + (material_id * data[0].price) / 100;

                    $('#amount' + id + '').val(amount);
                    sum();
                  }
                });

              } else if ((type_id == 2)) {

                var width_h = $('#width_h' + id + '').val();

                var height = $('#height' + id + '').val();
                var material = $('#material' + id + '').val();
                // alert(type_id);
                // alert(width_h);
                // alert(height);
                // alert('2');
                var calculate_sqm = (width_h * height);
                // alert(calculate_sqm);
                $.ajax({
                  url: 'http://localhost:9144/calculate_build_in',
                  method: "post",
                  type: 'json',
                  data: {
                    item_id: item_id,
                    type_id: type_id,
                    calculate_sqm: calculate_sqm,
                  },
                  success: function (data) {
                    // alert(data[0].price_rate);
                    // console.log(data[0].price_rate * calculate_sqm);
                    var amount = (data[0].price_rate * calculate_sqm);
                    var total = amount + (amount * material / 100)

                    $('#amount' + id + '').val(total);
                    sum();
                  }
                });
              }






            }
            $('#dynamic_field').on('change', '.width,.height', function () {
              var id = $(this).attr('name');
              calculate(id);

            });



            $('#dynamic_field').on('change', '.material', function () {
              var id = $(this).attr('name');
              calculate(id);
            })




            $('#dynamic_field').on('keyup', '.width', function () {
              var id = $(this).attr('name');
              calculate(id);
            });


            $('#new_client').click(function () {
              $('#new_client_modal').modal('show');
            })
            var postURL = "/save_quotation";
            var i = 1;
            $('#add').click(function () {
              i++;
              $('#dynamic_field').append('<div class="card mt-3 bg-section " id="row' + i +
                '"><div class="card-body">' +
                '<div  class="dynamic-added">' +
                '<div class="row"><div class="col-lg-6 col-sm-6 col-12 number">' + i + '.' +
                '</div><div class="col-lg-6 col-sm-6 col-12 text-end number"><i class="fa fa-times btn_remove" id="' +
                i + '" aria-hidden="true"></i></div></div>' +
                '<div class="row mb-3"><div class="col-lg-6 col-sm-6 col-12 txt-d">Item</div>' +
                '<div class="col-lg-6 col-sm-6 col-12"><input type="text" class="form-control txt-d-form item" id="item_select' +
                i +
                '" name="' + i + '">' +

                '<div class="item_list' + i + '" style="display:none;"><div>' +

                '</div>' +
                '</div></div>' +
                '<div class="row mb-3 txt-d-form"><div class="col-lg-6 col-sm-6 col-12">Type</div>' +
                '<div class="col-lg-6 col-sm-6 col-12"><select class="form-control txt-d-form type_name" name="' +
                i +
                '" id="type' + i + '">' +
                '</select></div><div class="col-lg-6 col-sm-6 col-12 txt-d-form">Dimemsion</div>' +
                '<div class="col-lg-6 col-sm-6 col-12"><div id="dimemsion_section' +
                i + '"><input type="text" class="form-control"></div></div></div>' +
                '<div class="row mb-3"><div class="col-lg-6 col-sm-6 col-12 txt-d-form">Add On</div><div class="col-lg-6 col-sm-6 col-12"><div id="addon_section' +
                i +
                '"></div><input type="hidden" class="form-control txt-d-form"></div><div class="col-lg-6 col-sm-6 col-6 txt-d-form">Material</div><div class="col-3"><div  class="txt-d-form material" name="' +
                i + '"  id="material' +
                i + '"></div></div></div>' +
                '<div class="row mb-3"><div class="col-lg-6 col-sm-6 col-6 txt-d-form">Amount</div><div class="col-lg-6 col-sm-6 col-12"><input type="text" class="form-control txt-d-form amount" id="amount' +
                i + '"></div></div>' +
                '<div></div></div></div></div>');
              $.ajax({
                url: 'http://localhost:9144/item',
                method: "get",
                type: 'json',
                success: function (data) {
                  var html = "<option>Item name (Required)</option>";
                  for (var j = 0; j < data.length; j++) {
                    html += '<option value="' + data[j].id + '">' + data[j].item_name + '</option>';
                  }
                  html += "</select>";
                  //  alert(html);
                  $('#row' + i + '').find('#item_select' + i + '').html(html);
                }
              });




              $.ajax({
                url: 'http://localhost:9144/type',
                method: "get",
                type: 'json',
                success: function (data) {
                  var html = "<option>Select Type</option>";
                  for (var j = 0; j < data.length; j++) {
                    html += '<option value="' + data[j].id + '">' + data[j].type_name + '</option>';
                  }
                  html += "</select>";
                  //  alert(html);
                  $('#row' + i + '').find('#type' + i + '').html(html);
                }
              });
            });
            $('#dynamic_field').on('change', '.type_name', function () {
              var idd = $(this).attr('name');

              calculate(idd);


              var id = $(this).val();

              if (id == 1) {
                $('#dimemsion_section' + idd + '').html(
                  '<input type="text" placeholder="W" class="form-control txt-d-form width"  name="' + idd +
                  '" id="width' + idd + '">');

              } else {
                $('#dimemsion_section' + idd + '').html(
                  '<input type="text" placeholder="W" class="form-control txt-d-form width" name="' + idd +
                  '" id="width_h' + idd +
                  '"><input type="text" placeholder="H" class="form-control txt-d-form height" name="' + idd +
                  '" id="height' + idd + '">'
                );

              }
            })

            $('#add_group').click(function () {
              $('#dynamic_field').append(
                '<div class="row mb-3 txt-d-form"><div class="col-3">Group name :</div><div class="col-9"><input type="text" class="form-control txt-d-form"></div></div>'
              );
            })
            $('#add_main').click(function () {
              $('#dynamic_field').append(
                '<div class="row mb-3 txt-d-form"><div class="col-3">Main name :</div><div class="col-9"><input type="text" class="form-control txt-d-form"></div></div>'
              );
            })
            $('#dynamic_field').on('change', '.item', function () {

              var idd = $(this).attr('name');

              calculate(idd);

              var id = $(this).val();
              //  alert(id);
              $.ajax({
                url: 'http://localhost:9144/get_addon/' + id + '',
                method: "get",
                type: 'json',
                success: function (data) {
                  console.log(data);
                  var html = '<div class="dropdown">' +
                    '<button class="btn btn-secondary txt-d-form dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
                    'Select Add On' +
                    '</button>' +
                    '<div class="dropdown-menu" aria-labelledby="dropdownMenuButton"><div class="txt-d-form">Add On</div>';
                  for (var j = 0; j < data.length; j++) {
                    html += '<a class="dropdown-item txt-d-form" href="#"><input type="checkbox"> ' +
                      data[j].add_on +
                      '</a>';
                  }
                  html += "</div></div>";
                  //  alert(html);
                  $('#row' + i + '').find('#addon_section' + idd + '').html(html);
                }
              });

              $.ajax({
                url: 'http://localhost:9144/get_material/' + id + '',
                method: "get",
                type: 'json',
                success: function (data) {
                  console.log(data);
                  var html = '<div class="dropdown">' +
                    '<button class="btn btn-secondary dropdown-toggle txt-d-form" type="button" id="dropdownMenuButton1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
                    'select material' +
                    '</button>' +
                    '<div class="dropdown-menu" aria-labelledby="dropdownMenuButton"><div class="txt-d-form">Material</div>';
                  for (var j = 0; j < data.length; j++) {
                    html += ' <a class="dropdown-item txt-d-form" href="#">' + data[j].material_name +
                      '</a>';
                  }
                  html += " </div></div>";
                  //  alert(html);
                  $('#row' + i + '').find('#material' + idd + '').html(html);
                }
              });
            });
            $('#dynamic_field').on('click', '.item', function () {

              var id = $(this).attr('name');
              $('#item_list' + id + '').css('display', 'block');
              alert('xxx');
            });
            $(document).on('click', '.btn_remove', function () {
              var button_id = $(this).attr("id");
              $('#row' + button_id + '').remove();
            });
            $('#add_name').submit(function (e) {
              e.preventDefault();
              var dd = $('#add_name').serializeArray();

              $.ajax({
                url: postURL,
                method: "POST",
                data: JSON.stringify({
                  'dd': dd
                }),
                contentType: 'application/json; charset=utf-8',
                type: 'json',
                success: function (data) {
                  i = 1;
                  $('.dynamic-added').remove();
                  $('#add_name')[0].reset();
                  alert('Record Inserted Successfully.');
                }
              });
            });
          });
        </script>
        </body>
        </html>
    </main>

  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous">
</script>
<script src="js/scripts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" crossorigin="anonymous"></script>
<script src="js/datatables-simple-demo.js"></script>
</body>
</html>